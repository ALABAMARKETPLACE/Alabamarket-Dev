name: Deploy Frontend

on:
  push:
    branches: [main, dev]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'production' || 'development' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Deployment Context
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "SERVER_HOST=${{ vars.PROD_SERVER_HOST }}" >> $GITHUB_ENV
            echo "SERVER_USER=${{ vars.PROD_SERVER_USER }}" >> $GITHUB_ENV
            echo "APP_DIR=/home/${{ vars.PROD_SERVER_USER }}/alaba-marketplace-production/website" >> $GITHUB_ENV
            echo "APP_NAME=alabamarketplace-frontend" >> $GITHUB_ENV
            echo "ENVIRONMENT=production" >> $GITHUB_ENV

            echo "SSH_KEY<<EOF" >> $GITHUB_ENV
            echo "${{ secrets.PROD_SSH_PRIVATE_KEY }}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "SERVER_HOST=${{ vars.DEV_SERVER_HOST }}" >> $GITHUB_ENV
            echo "SERVER_USER=${{ vars.DEV_SERVER_USER }}" >> $GITHUB_ENV
            echo "APP_DIR=${{ vars.DEV_SCRIPT_PATH }}" >> $GITHUB_ENV
            echo "APP_NAME=alabamarketplace-frontend" >> $GITHUB_ENV
            echo "ENVIRONMENT=development" >> $GITHUB_ENV

            echo "SSH_KEY<<EOF" >> $GITHUB_ENV
            echo "${{ secrets.DEV_SSH_PRIVATE_KEY }}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$SERVER_HOST" >> ~/.ssh/known_hosts

      - name: Sync to Server
        run: |
          # The --delete flag ensures the server matches the repo exactly
          rsync -avz --delete \
            --exclude node_modules \
            --exclude .next \
            --exclude .env \
            --exclude .git \
            --exclude .github \
            . \
            $SERVER_USER@$SERVER_HOST:$APP_DIR/

      - name: Execute Remote Script
        run: |
          # Pass variables to the script and execute it
          ssh "$SERVER_USER@$SERVER_HOST" "export APP_NAME=$APP_NAME; export APP_DIR=$APP_DIR; bash $APP_DIR/deploy.sh"
