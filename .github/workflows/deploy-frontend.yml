name: Deploy Frontend (Website)

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------
      # Set environment based on branch
      # -----------------------------
      - name: Set deployment environment
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "SERVER_HOST=${{ vars.PROD_SERVER_HOST }}" >> $GITHUB_ENV
            echo "SERVER_USER=${{ vars.PROD_SERVER_USER }}" >> $GITHUB_ENV
            echo "APP_DIR=/home/${{ vars.PROD_SERVER_USER }}/alaba-marketplace-production/website" >> $GITHUB_ENV
            echo "APP_NAME=alabamarketplace" >> $GITHUB_ENV
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "SSH_KEY=${{ secrets.PROD_SSH_PRIVATE_KEY }}" >> $GITHUB_ENV
          else
            echo "SERVER_HOST=${{ vars.DEV_SERVER_HOST }}" >> $GITHUB_ENV
            echo "SERVER_USER=${{ vars.DEV_SERVER_USER }}" >> $GITHUB_ENV
            echo "APP_DIR=/home/${{ vars.DEV_SERVER_USER }}/alaba-marketplace/website" >> $GITHUB_ENV
            echo "APP_NAME=alabamarketplace-frontend" >> $GITHUB_ENV
            echo "ENVIRONMENT=development" >> $GITHUB_ENV
            echo "SSH_KEY=${{ secrets.DEV_SSH_PRIVATE_KEY }}" >> $GITHUB_ENV
          fi

      # -----------------------------
      # Setup SSH (branch-aware key)
      # -----------------------------
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

      # -----------------------------
      # Ensure target directory exists
      # -----------------------------
      - name: Ensure target directory exists
        run: |
          ssh $SERVER_USER@$SERVER_HOST "mkdir -p $APP_DIR"

      # -----------------------------
      # Sync frontend files
      # -----------------------------
      - name: Sync frontend source
        run: |
          rsync -avz --delete \
            --exclude node_modules \
            --exclude .next \
            --exclude .env \
            --exclude .git \
            --exclude .github \
            --exclude .gitignore \
            --exclude public \
            . \
            $SERVER_USER@$SERVER_HOST:$APP_DIR/

      # -----------------------------
      # Build & restart frontend
      # -----------------------------
      - name: Build & restart frontend
        run: |
          ssh $SERVER_USER@$SERVER_HOST << EOF
            set -e

            # ---- Load NVM (non-interactive SSH fix) ----
            export NVM_DIR="\$HOME/.nvm"
            [ -s "\$NVM_DIR/nvm.sh" ] && . "\$NVM_DIR/nvm.sh"
            nvm use 20.19.6

            cd $APP_DIR

            npm install --legacy-peer-deps
            npm run build

            PM2="\$HOME/.nvm/versions/node/v20.19.6/bin/pm2"

            if [[ "$ENVIRONMENT" == "production" ]]; then
              # ---- Production: clean restart ----
              \$PM2 delete $APP_NAME || true
              \$PM2 start npm --name $APP_NAME -- start
            else
              # ---- Development: ecosystem ----
              \$PM2 reload ../ecosystem.config.js --only $APP_NAME || \
              \$PM2 start ../ecosystem.config.js
            fi

            \$PM2 save
          EOF

      # -----------------------------
      # Deployment summary
      # -----------------------------
      - name: Deployment info
        run: |
          echo "âœ… Branch: $GITHUB_REF_NAME"
          echo "ðŸŒ Environment: $ENVIRONMENT"
          echo "ðŸ–¥ï¸ Server: $SERVER_USER@$SERVER_HOST"
          echo "ðŸ“ Directory: $APP_DIR"
