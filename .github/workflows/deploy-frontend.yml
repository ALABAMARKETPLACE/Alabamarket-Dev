name: Deploy Frontend

on:
  push:
    branches: [main, dev]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'production' || 'development' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Deployment Context
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "HOST=${{ vars.PROD_SERVER_HOST }}" >> $GITHUB_ENV
            echo "USER=${{ vars.PROD_SERVER_USER }}" >> $GITHUB_ENV
            echo "DIR=/home/${{ vars.PROD_SERVER_USER }}/alaba-marketplace-production/website" >> $GITHUB_ENV
            echo "NAME=alabamarket-prod" >> $GITHUB_ENV
            echo "SSH_KEY=${{ secrets.PROD_SSH_PRIVATE_KEY }}" >> $GITHUB_ENV
          else
            echo "HOST=${{ vars.DEV_SERVER_HOST }}" >> $GITHUB_ENV
            echo "USER=${{ vars.DEV_SERVER_USER }}" >> $GITHUB_ENV
            echo "DIR=${{ vars.DEV_SCRIPT_PATH }}" >> $GITHUB_ENV
            echo "NAME=alabamarket-dev" >> $GITHUB_ENV
            echo "SSH_KEY=${{ secrets.DEV_SSH_PRIVATE_KEY }}" >> $GITHUB_ENV
          fi

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts

      - name: Sync to Server
        run: |
          # The --delete flag ensures the server matches the repo exactly
          rsync -avz --delete \
            --exclude '.git*' \
            --exclude 'node_modules' \
            --exclude '.next' \
            ./ "$USER@$HOST:$DIR/"

      - name: Execute Remote Script
        run: |
          # Pass variables to the script and execute it
          ssh "$USER@$HOST" "export APP_NAME=$NAME; export APP_DIR=$DIR; bash $DIR/deploy.sh"
