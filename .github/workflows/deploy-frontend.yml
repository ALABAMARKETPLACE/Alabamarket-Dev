name: Deploy Frontend (Website)

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'production' || 'development' }}

    steps:
      # -------------------------------------------------
      # Checkout
      # -------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------------------------------
      # Set environment based on branch
      # -------------------------------------------------
      - name: Set deployment environment
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "SERVER_HOST=${{ vars.PROD_SERVER_HOST }}" >> $GITHUB_ENV
            echo "SERVER_USER=${{ vars.PROD_SERVER_USER }}" >> $GITHUB_ENV
            echo "APP_DIR=/home/${{ vars.PROD_SERVER_USER }}/alaba-marketplace-production/website" >> $GITHUB_ENV
            echo "APP_NAME=alabamarketplace-frontend" >> $GITHUB_ENV
            echo "ENVIRONMENT=production" >> $GITHUB_ENV

            echo "SSH_KEY<<EOF" >> $GITHUB_ENV
            echo "${{ secrets.PROD_SSH_PRIVATE_KEY }}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "SERVER_HOST=${{ vars.DEV_SERVER_HOST }}" >> $GITHUB_ENV
            echo "SERVER_USER=${{ vars.DEV_SERVER_USER }}" >> $GITHUB_ENV
            echo "APP_DIR=${{ vars.DEV_SCRIPT_PATH }}" >> $GITHUB_ENV
            echo "APP_NAME=alabamarketplace-frontend" >> $GITHUB_ENV
            echo "ENVIRONMENT=development" >> $GITHUB_ENV

            echo "SSH_KEY<<EOF" >> $GITHUB_ENV
            echo "${{ secrets.DEV_SSH_PRIVATE_KEY }}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      # -------------------------------------------------
      # Debug values
      # -------------------------------------------------
      - name: Debug deployment variables
        run: |
          echo "Branch      : $GITHUB_REF_NAME"
          echo "Environment : $ENVIRONMENT"
          echo "Server      : $SERVER_USER@$SERVER_HOST"
          echo "App Dir     : $APP_DIR"
          echo "SSH Key     : ${SSH_KEY:+SET}"

      # -------------------------------------------------
      # Setup SSH v
      # -------------------------------------------------
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$SERVER_HOST" >> ~/.ssh/known_hosts

      # -------------------------------------------------
      # Ensure target directory exists
      # -------------------------------------------------
      - name: Ensure target directory exists
        run: |
          ssh $SERVER_USER@$SERVER_HOST "mkdir -p $APP_DIR"

      # -------------------------------------------------
      # Sync frontend source
      # -------------------------------------------------
      - name: Sync frontend source
        run: |
          rsync -avz --delete \
            --exclude node_modules \
            --exclude .next \
            --exclude .env \
            --exclude .git \
            --exclude .github \
            . \
            $SERVER_USER@$SERVER_HOST:$APP_DIR/

      # -------------------------------------------------
      # Build & restart frontend (PM2 SSR)
      # -------------------------------------------------
      - name: Build & restart frontend
        run: |
          ssh $SERVER_USER@$SERVER_HOST << EOF
            set -e

            # Load NVM
            export NVM_DIR="$HOME/.nvm"
            [ -s "\$NVM_DIR/nvm.sh" ] && . "\$NVM_DIR/nvm.sh"
            nvm use 20.19.6

            cd "$APP_DIR"

            npm install --legacy-peer-deps
            npm run build

            PM2="\$HOME/.nvm/versions/node/v20.19.6/bin/pm2"

            # Check if app already exists
            set +e
            \$PM2 describe "$APP_NAME" > /dev/null 2>&1
            EXISTS=\$?
            set -e

            if [ "\$EXISTS" -eq 0 ]; then
              echo "Reloading frontend..."
              \$PM2 reload "$APP_NAME"
            else
              echo "Starting frontend..."
              \$PM2 start npm \
                --name "$APP_NAME" \
                --cwd "$APP_DIR" \
                -- start
            fi

            \$PM2 save
          EOF

      # -------------------------------------------------
      # Deployment summary
      # -------------------------------------------------
      - name: Deployment info
        run: |
          echo "‚úÖ Branch: $GITHUB_REF_NAME"
          echo "üåç Environment: $ENVIRONMENT"
          echo "üñ•Ô∏è Server: $SERVER_USER@$SERVER_HOST"
          echo "üìÅ Directory: $APP_DIR"
