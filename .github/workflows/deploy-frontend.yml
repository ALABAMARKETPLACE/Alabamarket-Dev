name: Deploy Frontend (Production Website)

on:
  push:
    branches:
      - master
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ vars.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Sync frontend source (production)
        run: |
          rsync -avz --delete \
            --exclude node_modules \
            --exclude .next \
            --exclude .env \
            --exclude .git \
            --exclude .github \
            --exclude .gitignore \
            . \
            ${{ vars.SERVER_USER }}@${{ vars.SERVER_HOST }}:/home/alabamarketplace_prod_user/alaba-marketplace-production/website/

      - name: Build & restart frontend (PM2, no ecosystem)
        run: |
          ssh ${{ vars.SERVER_USER }}@${{ vars.SERVER_HOST }} << 'EOF'
          set -e

          # ---- LOAD NVM (CRITICAL) ----
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

          nvm use 20.19.6

          cd /home/alabamarketplace_prod_user/alaba-marketplace-production/website

          npm install --legacy-peer-deps
          npm run build

          PM2="$HOME/.nvm/versions/node/v20.19.6/bin/pm2"

          $PM2 delete alabamarketplace || true

          # ---- NEXT.JS PRODUCTION START ----
          $PM2 start npm \
            --name alabamarketplace \
            -- start

          $PM2 save
          EOF
